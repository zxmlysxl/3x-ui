name: Upstream Sync

on:
  schedule:
    - cron: "15 19 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_with_upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # 重要：避免凭证残留

      # 关键修复步骤：彻底重置工作区
      - name: Reset workspace
        run: |
          git config --global user.name "zxmlysxl"
          git config --global user.email "zxmlysxl@gmail.com"
          git reset --hard HEAD
          git clean -fd
          git restore --staged . || true
          git restore . || true

      # 使用原生git命令替代第三方action
      - name: Hard Sync with Upstream
        run: |
          git remote add upstream https://github.com/MHSanaei/3x-ui.git || true
          git fetch upstream main
          git reset --hard upstream/main
          
          # 选择性保留文件（如需要保留自己的workflows）
          # git checkout origin/main -- .github/workflows/ || true

          git push origin main --force

      - name: Handle Failure
        if: failure()
        run: |
          echo "::error::自动同步失败，请手动执行以下命令："
          echo "git remote add upstream https://github.com/MHSanaei/3x-ui.git"
          echo "git fetch upstream"
          echo "git reset --hard upstream/main"
          echo "git push origin main --force"
