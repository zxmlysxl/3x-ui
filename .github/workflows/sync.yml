name: Upstream Sync

on:
  schedule:
    - cron: "15 19 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_with_upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 重置所有更改，确保工作区干净
      - name: Clean workspace
        run: |
          git reset --hard
          git clean -fd

      # 临时删除工作流文件避免冲突
      - name: Remove workflow files temporarily
        run: |
          git rm --cached -r .github/workflows/ || true
          rm -rf .github/workflows/ || true
          mkdir -p .github/workflows

      - name: Sync Upstream
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4.1
        with:
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_sync_repo: MHSanaei/3x-ui
          upstream_sync_branch: main
          target_sync_branch: main
          git_config_pull_rebase: true
          target_branch_push_args: "--force-with-lease"  # 使用合法的强制推送参数

      # 恢复工作流文件（如果需要保留原工作流）
      - name: Restore workflow files
        run: |
          git checkout origin/main -- .github/workflows/ || true
          git reset .github/workflows/ || true

      - name: Final Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Sync upstream (excluding workflow changes)" || echo "No changes to commit"
          git push origin main
